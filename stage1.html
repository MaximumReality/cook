<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Harira Quest">
    <link rel="apple-touch-icon" href="mochkil-harira.PNG">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>Harira Harvest | Maximum Reality</title>
    <style>
        :root { --neon-green: #39FF14; --neon-cyan: #00FFFF; --neon-pink: #FF00FF; }
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        
        #bg-container {
            position: fixed; inset: 0;
            background: url('cyber-kitchen-bg.PNG') no-repeat center center fixed;
            background-size: cover;
            z-index: -1;
        }

        #bg-container::before {
            content: ""; position: absolute; inset: 0;
            background: rgba(0, 0, 0, 0.6); 
        }

        #ui { 
            position: absolute; top: 100px; 
            left: 20px; 
            color: var(--neon-cyan); font-size: 18px; z-index: 100; 
            text-shadow: 2px 2px #000; pointer-events: none;
            font-family: 'Courier New', monospace;
        }
        .checklist { color: var(--neon-green); margin-top: 5px; }
        canvas { position: absolute; inset: 0; z-index: 10; }

        /* CINEMATIC OVERLAY STYLES */
        #video-overlay {
            display: none; 
            position: fixed; 
            inset: 0; 
            background: #000; 
            z-index: 9999; 
            justify-content: center; 
            align-items: center;
        }
        #transition-video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures it fills the iPhone screen */
        }
    </style>
</head>
<body>

<div id="bg-container"></div>
<div id="ui">
    RECIPE: HARIRA BASE<br>
    <div id="check-list" class="checklist">
        - Chickpeas: 0/5<br>
        - Lentils: 0/5<br>
        - Garlic Claws: 0/2
    </div>
</div>

<div id="video-overlay">
    <video id="transition-video" playsinline muted>
        <source src="insecticide.mp4" type="video/mp4">
    </video>
</div>


<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const videoOverlay = document.getElementById('video-overlay');
const transitionVideo = document.getElementById('transition-video');

const music = new Audio('that-8-bit-music.mp3'); 
music.loop = true;

const startMusic = () => {
    music.play().catch(e => {});
    window.removeEventListener('touchstart', startMusic);
};
window.addEventListener('touchstart', startMusic);

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

let chefX = canvas.width / 2;
let items = [];
let gameActive = true;

const recipe = {
    chickpea: { count: 0, target: 5, color: '#f5deb3' },
    lentil: { count: 0, target: 5, color: '#a52a2a' },
    garlic: { count: 0, target: 2, color: '#ffffff' }
};

const sprites = {
    chickpea: new Image(), lentil: new Image(),
    garlic: new Image(), mochkil: new Image()
};
sprites.chickpea.src = 'chickpeas.png';
sprites.lentil.src = 'lentil.png';
sprites.garlic.src = 'garlic.png';
sprites.mochkil.src = 'mochkil-harira.png';

window.addEventListener('touchmove', e => {
    if (!gameActive) return;
    e.preventDefault();
    let touchX = e.touches[0].clientX;
    chefX = Math.max(80, Math.min(touchX, canvas.width - 80));
}, {passive: false});

class Ingredient {
    constructor() {
        let rand = Math.random();
        if (rand < 0.15) this.type = 'pest'; 
        else if (rand < 0.6) this.type = 'lentil';
        else if (rand < 0.8) this.type = 'chickpea';
        else this.type = 'garlic';

        this.x = Math.random() * (canvas.width - 60) + 30;
        this.y = -80;
        this.speed = 4.5 + Math.random() * 5.5;
    }
    update() { 
        this.y += this.speed;
        if (this.type === 'pest') this.x += Math.sin(this.y / 25) * 3; 
    }
    draw() {
        if (this.type === 'pest') {
            ctx.font = "75px serif"; 
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#39FF14";
            ctx.fillText("ðŸª³", this.x - 35, this.y);
        } else {
            const img = sprites[this.type];
            if (img.complete) {
                ctx.shadowBlur = 15;
                ctx.shadowColor = recipe[this.type].color;
                ctx.drawImage(img, this.x - 25, this.y - 25, 50, 50);
            }
        }
        ctx.shadowBlur = 0;
    }
}

function updateUI() {
    document.getElementById('check-list').innerHTML = `
        - Chickpeas: ${recipe.chickpea.count}/${recipe.chickpea.target}<br>
        - Lentils: ${recipe.lentil.count}/${recipe.lentil.target}<br>
        - Garlic Claws: ${recipe.garlic.count}/${recipe.garlic.target}
    `;
}

// MODIFIED: WIN CONDITION TRIGGERS CINEMATIC
function checkWin() {
    if (recipe.chickpea.count >= recipe.chickpea.target &&
        recipe.lentil.count >= recipe.lentil.target &&
        recipe.garlic.count >= recipe.garlic.target) {
        
        gameActive = false;
        music.pause();
        
        videoOverlay.style.display = 'flex';

        // THE SECRET SAUCE FOR IPHONE:
        // We unmute it right as we call play. 
        // Because the user was just touching the screen to catch ingredients, 
        // the browser "trusts" this play command.
        transitionVideo.muted = false; 
        
        const playPromise = transitionVideo.play();

        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.log("Auto-play prevented, adding emergency play button");
                // If it still fails, we force a "Tap to Continue" button
                const btn = document.createElement("button");
                btn.innerText = "NEXT: CLEAN KITCHEN";
                btn.style.cssText = "position:fixed; z-index:10001; top:50%; left:50%; transform:translate(-50%,-50%); padding:20px; background:#FF00FF; color:#fff; border:none; border-radius:10px;";
                btn.onclick = () => {
                    transitionVideo.play();
                    btn.remove();
                };
                document.body.appendChild(btn);
            });
        }

        transitionVideo.onended = () => {
            window.location.href = 'stage2.html';
        };
    }
}


function loop() {
    if (!gameActive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (Math.random() < 0.07) items.push(new Ingredient());
    
    const chefWidth = 160; 
    const scale = chefWidth / sprites.mochkil.width;
    const chefHeight = sprites.mochkil.height * scale;

    items.forEach((item, index) => {
        item.update();
        item.draw();
        
        if (item.y > canvas.height - chefHeight - 20 && item.y < canvas.height - chefHeight + 80 &&
            item.x > chefX - 55 && item.x < chefX + 55) {
            
            if (item.type === 'pest') {
                recipe.chickpea.count = 0;
                recipe.lentil.count = 0;
                recipe.garlic.count = 0;
                if (navigator.vibrate) navigator.vibrate([200, 50, 200]); 
            } else {
                recipe[item.type].count = Math.min(recipe[item.type].count + 1, recipe[item.type].target);
                if (navigator.vibrate) navigator.vibrate(20); 
            }
            
            updateUI();
            items.splice(index, 1);
            checkWin();
        }
        if (item.y > canvas.height + 100) items.splice(index, 1);
    });

    if (sprites.mochkil.complete) {
        ctx.shadowBlur = 20;
        ctx.shadowColor = 'rgba(0, 255, 255, 0.5)';
        ctx.drawImage(sprites.mochkil, chefX - (chefWidth/2), canvas.height - chefHeight - 20, chefWidth, chefHeight);
        ctx.shadowBlur = 0;
    }
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
