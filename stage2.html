<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Harira Quest">
    <link rel="apple-touch-icon" href="mochkil-harira.PNG">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>The Mash | Snack Attack</title>
    <style>
    :root { 
        --neon-blue: #00FFEF; --neon-pink: #FF00FF; --neon-green: #39FF14; --neon-cyan: #00FFFF;
    }

    body {
        margin: 0; padding: 0;
        background: url('cyber-kitchen-bg.PNG') no-repeat center center fixed;
        background-size: cover;
        height: 100vh; overflow: hidden; background-color: #000;
    }

    body::before {
        content: ""; position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.6); z-index: 0;
    }

    #landscape-blocker {
        display: none; position: fixed; inset: 0;
        background: #000; z-index: 9999; flex-direction: column;
        justify-content: center; align-items: center;
        font-family: 'Courier New', monospace; text-align: center;
    }
    @media screen and (orientation: portrait) { #landscape-blocker { display: flex; } }

    /* CINEMATIC OVERLAY */
    #video-overlay {
        display: none; position: fixed; inset: 0;
        background: #000; z-index: 10000;
        justify-content: center; align-items: center;
    }

    /* THE PIVOT */
    .rotate-video {
        width: 100vh; height: 100vw;
        object-fit: cover;
    }

    .hacker-box {
        border: 2px solid var(--neon-cyan); padding: 20px;
        background: rgba(0, 255, 255, 0.05); box-shadow: 0 0 15px var(--neon-cyan);
        border-radius: 12px; width: 280px;
    }
    .glitch-cat { width: 110px; margin-bottom: 15px; filter: drop-shadow(0 0 10px var(--neon-pink)); }
    .neon-text { color: var(--neon-pink); font-size: 1.2rem; letter-spacing: 1px; margin-bottom: 10px; }
    
    #ui-text { position: absolute; top: 85px; left: 20px; z-index: 100; pointer-events: none; font-family: 'Courier New', monospace; }
    .stat { color: var(--neon-blue); font-size: 20px; font-weight: bold; text-shadow: 2px 2px #000; }
    #game-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; z-index: 10; }
    #bowl-img { width: 100%; height: auto; }
    #ladle-img { position: absolute; width: 140px; z-index: 20; pointer-events: none; top: 20%; left: 50%; transform: translateX(-50%); }
    #azul-hud { position: absolute; top: 80px; right: 20px; width: 110px; border: 2px solid var(--neon-blue); background: rgba(0, 255, 239, 0.15); border-radius: 10px; text-align: center; font-size: 10px; z-index: 100; backdrop-filter: blur(5px); }
</style>
</head>
<body>

<div id="landscape-blocker">
    <div class="hacker-box">
        <img src="mochkil-harira.png" alt="Mochkil" class="glitch-cat">
        <h2 class="neon-text">ROTATE YOUR DEVICE</h2>
    </div>
</div>

<div id="video-overlay">
    <video id="transition-video" class="rotate-video" playsinline muted>
        <source src="needs-flavor.mp4" type="video/mp4">
    </video>
</div>

<div id="ui-text"><div class="stat">DENSITY: <span id="density-val">0</span>%</div></div>

<div id="azul-hud">
    <img src="azul-insight.png" style="width: 80%; margin-top:5px;">
    <div id="azul-msg" style="color: var(--neon-blue); padding: 5px;">STIRRING...</div>
</div>

<div id="game-container">
    <img src="bowl-with-soup.png" id="bowl-img">
    <img src="ladle.png" id="ladle-img">
</div>

<script>
    const music = new Audio('ready-to-play.mp3');
    music.loop = true;

    const ladle = document.getElementById('ladle-img');
    const container = document.getElementById('game-container');
    const densityVal = document.getElementById('density-val');
    const videoOverlay = document.getElementById('video-overlay');
    const transitionVideo = document.getElementById('transition-video');
    const azulMsg = document.getElementById('azul-msg');

    let totalRotation = 0;
    let lastAngle = null;
    let isDone = false;

    window.addEventListener('touchstart', () => { if(music.paused) music.play(); }, {once: true});

    window.addEventListener('touchmove', (e) => {
        if (isDone) return;
        e.preventDefault();
        
        const touch = e.touches[0];
        const rect = container.getBoundingClientRect();
        const lx = touch.clientX - rect.left - 70; 
        const ly = touch.clientY - rect.top - 70;
        
        ladle.style.left = lx + 'px';
        ladle.style.top = ly + 'px';

        const dx = (lx + 70) - (rect.width / 2);
        const dy = (ly + 70) - (rect.height / 2);
        const angle = Math.atan2(dy, dx);
        
        if (lastAngle !== null) {
            let diff = angle - lastAngle;
            if (diff > Math.PI) diff -= Math.PI * 2;
            if (diff < -Math.PI) diff += Math.PI * 2;
            
            totalRotation += Math.abs(diff);
            const progress = Math.min((totalRotation / (Math.PI * 25)) * 100, 100);
            
            densityVal.innerText = Math.floor(progress);
            ladle.style.transform = `rotate(${angle + 1.5}rad)`; 

            if (progress >= 100) {
                triggerCinematic();
            }
        }
        lastAngle = angle;
    }, { passive: false });

    function triggerCinematic() {
        if (isDone) return;
        isDone = true;
        music.pause();
        azulMsg.innerText = "TASTE TEST...";
        if(navigator.vibrate) navigator.vibrate(200);

        // Show Video Overlay
        videoOverlay.style.display = 'flex';
        
        // The iPhone Handshake
        transitionVideo.muted = false;
        const playPromise = transitionVideo.play();

        if (playPromise !== undefined) {
            playPromise.catch(error => {
                // Emergency bypass if Safari blocks it
                videoOverlay.onclick = () => { transitionVideo.play(); };
                azulMsg.innerText = "TAP TO TASTE";
            });
        }

        transitionVideo.onended = () => {
            window.location.href = 'stage3.html';
        };
    }
</script>
</body>
</html>
